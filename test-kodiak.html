<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kodiak API Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            background: #00c4ef;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #00a0cf;
        }
        .log {
            background: #000;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #0f0;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .warning { color: #ff0; }
        .info { color: #0af; }
    </style>
</head>
<body>
    <h1>ğŸ» Kodiak API æµ‹è¯•å·¥å…·</h1>
    
    <div>
        <button onclick="testQuote()">æµ‹è¯•è·å–æŠ¥ä»· (BERA â†’ DP)</button>
        <button onclick="testQuoteWithRecipient()">æµ‹è¯•è·å–å®Œæ•´æŠ¥ä»·ï¼ˆå«æ¥æ”¶åœ°å€ï¼‰</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="log" id="log"></div>

    <script src="js/libs/ethers-5.7.2.umd.min.js"></script>
    <script src="kodiak-api.js"></script>

    <script>
        const logDiv = document.getElementById('log');
        
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }

        function clearLog() {
            logDiv.innerHTML = '';
        }

        async function testQuote() {
            log('=== å¼€å§‹æµ‹è¯• Kodiak API æŠ¥ä»·ï¼ˆæ— æ¥æ”¶åœ°å€ï¼‰===', 'info');
            
            try {
                const kodiakAPI = new KodiakAPI();
                log('âœ“ KodiakAPI å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                const tokenIn = '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'; // BERA
                const tokenOut = '0xf7C464c7832e59855aa245Ecc7677f54B3460e7d'; // DP
                const amount = '1';
                
                log(`è¯·æ±‚å‚æ•°:`, 'info');
                log(`  TokenIn: ${tokenIn} (BERA)`, 'info');
                log(`  TokenOut: ${tokenOut} (DP)`, 'info');
                log(`  Amount: ${amount}`, 'info');
                
                log('æ­£åœ¨è°ƒç”¨ Kodiak API...', 'warning');
                const quote = await kodiakAPI.getQuote(
                    tokenIn,
                    tokenOut,
                    amount,
                    null,  // No recipient
                    null,  // No slippage
                    18
                );
                
                log('âœ“ API è°ƒç”¨æˆåŠŸï¼', 'success');
                log('åŸå§‹å“åº”:', 'info');
                log(JSON.stringify(quote, null, 2), 'info');
                
                // Format quote
                const formatted = kodiakAPI.formatQuote(quote);
                log('æ ¼å¼åŒ–åçš„æŠ¥ä»·:', 'success');
                log(`  è¾“å‡ºæ•°é‡: ${formatted.amountOut}`, 'success');
                log(`  æ±‡ç‡: ${formatted.rate}`, 'success');
                log(`  ä»·æ ¼å½±å“: ${(formatted.priceImpact * 100).toFixed(2)}%`, 'success');
                log(`  Gas ä¼°ç®—: ${formatted.gasEstimate}`, 'success');
                log(`  Gas USD: $${formatted.gasEstimateUSD}`, 'success');
                log(`  è·¯ç”±: ${formatted.routeString}`, 'success');
                
            } catch (error) {
                log('âœ— æµ‹è¯•å¤±è´¥ï¼', 'error');
                log(`é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }

        async function testQuoteWithRecipient() {
            log('=== å¼€å§‹æµ‹è¯• Kodiak API å®Œæ•´æŠ¥ä»·ï¼ˆå«æ¥æ”¶åœ°å€ï¼‰===', 'info');
            
            try {
                const kodiakAPI = new KodiakAPI();
                log('âœ“ KodiakAPI å®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                const tokenIn = '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'; // BERA
                const tokenOut = '0xf7C464c7832e59855aa245Ecc7677f54B3460e7d'; // DP
                const amount = '1';
                const recipient = '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb';  // æµ‹è¯•åœ°å€
                const slippage = 0.5;
                
                log(`è¯·æ±‚å‚æ•°:`, 'info');
                log(`  TokenIn: ${tokenIn} (BERA)`, 'info');
                log(`  TokenOut: ${tokenOut} (DP)`, 'info');
                log(`  Amount: ${amount}`, 'info');
                log(`  Recipient: ${recipient}`, 'info');
                log(`  Slippage: ${slippage}%`, 'info');
                
                log('æ­£åœ¨è°ƒç”¨ Kodiak API...', 'warning');
                const swapData = await kodiakAPI.getSwapData(
                    tokenIn,
                    tokenOut,
                    amount,
                    recipient,
                    slippage,
                    18
                );
                
                log('âœ“ API è°ƒç”¨æˆåŠŸï¼', 'success');
                log('äº¤æ˜“æ•°æ®:', 'success');
                log(`  Router åœ°å€: ${swapData.to}`, 'success');
                log(`  Calldata é•¿åº¦: ${swapData.data.length} å­—èŠ‚`, 'success');
                log(`  Value: ${swapData.value}`, 'success');
                log(`  è¾“å‡ºæ•°é‡: ${swapData.quote.amountOut}`, 'success');
                log(`  æ±‡ç‡: ${swapData.quote.rate}`, 'success');
                
                log('å®Œæ•´å“åº”:', 'info');
                log(JSON.stringify(swapData, null, 2), 'info');
                
            } catch (error) {
                log('âœ— æµ‹è¯•å¤±è´¥ï¼', 'error');
                log(`é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
                log(`é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œç®€å•æµ‹è¯•
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•', 'success');
            log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯• Kodiak API', 'info');
        });
    </script>
</body>
</html>
